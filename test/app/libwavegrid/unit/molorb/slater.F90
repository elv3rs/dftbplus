!--------------------------------------------------------------------------------------------------!
!  DFTB+: general package for performing fast atomistic simulations                                !
!  Copyright (C) 2006 - 2025  DFTB+ developers group                                               !
!                                                                                                  !
!  See the LICENSE file for terms of usage and distribution.                                       !
!--------------------------------------------------------------------------------------------------!

#:include "fortuno_serial.fypp"

module test_libwavegrid_slater
  use dftbp_common_accuracy, only : dp
  use libwavegrid, only : TSlaterOrbital
  use fortuno_serial, only : suite => serial_suite_item, test_list, is_close, test_item 
  $:FORTUNO_SERIAL_IMPORTS()
  implicit none
  
  private
  public :: tests

  !> Allow 0.001% relative error
  real(dp), parameter :: rtol = 1.0e-5_dp



contains
  !> Check if initialisation from LUT and subsequent 
  !! Access works as expected.
  $:TEST("slater_fromLut")
    type(TSlaterOrbital) :: sto
    real(dp) :: r, val, expected
    integer :: i
    integer, parameter :: angMom = 0 ! Only relevant for realTessY
    real(dp), parameter :: gridDist = 1.0_dp
    ! f(x)=x^2
    real(dp), parameter :: gridValue(5) = [0.0_dp, 1.0_dp, 4.0_dp, 9.0_dp, 16.0_dp]
    ! Lut access is simple linear interpolation 
    real(dp), parameter :: checkedPairs(2,7) = reshape([&
        0.0_dp, 0.0_dp, &
        0.5_dp, 0.5_dp, &
        1.0_dp, 1.0_dp, &
        1.5_dp, 2.5_dp, &
        3.1_dp, 0.9_dp*9.0_dp + 0.1_dp*16.0_dp, &
        4.0_dp, 0.0_dp, &  ! no i+1 for interpolation
        4.01_dp, 0.0_dp &  ! beyond cutoff
      ], [2,7])


    call sto%initFromLut(gridValue, gridDist, angMom)
    @:ASSERT(sto%angMom == angMom)

    do i = 1, size(checkedPairs, 2)
      r = checkedPairs(1, i)
      expected = checkedPairs(2, i)
      val = sto%getRadial(r)
      print *, "r=", r, " val=", val, " expected=", expected
      @:CHECK(is_close(val, expected, rtol=rtol))
    end do 
  $:END_TEST()


  !> Register test cases with Fortuno

  function tests()
    type(test_list) :: tests

    tests = test_list([&
        suite("slater", test_list([&
            $:TEST_ITEMS()
        ]))&
    ])
    $:STOP_ON_MISSING_TEST_ITEMS()

  end function tests

end module test_libwavegrid_slater
